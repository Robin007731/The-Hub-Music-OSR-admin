<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSR Admin - Control Maestro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1DB954; --bg: #000000; --panel: #121212; --card: #181818; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* REPRODUCTOR */
        .player-area { flex: 2; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #yt-player { width: 100%; flex-grow: 1; background: #000; }
        .now-playing { padding: 25px; background: #121212; display: flex; align-items: center; border-top: 2px solid var(--primary); }
        .info-box { flex: 1; margin-left: 20px; }
        
        /* SIDEBAR SINCRONIZADA */
        .sidebar { flex: 1; background: var(--panel); display: flex; flex-direction: column; min-width: 350px; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #222; font-weight: 900; color: var(--primary); }
        .list-scroll { flex: 1; overflow-y: auto; padding: 15px; }
        .section-title { font-size: 11px; color: #555; text-transform: uppercase; margin: 15px 0; display: block; }

        .track-card { display: flex; align-items: center; background: var(--card); padding: 10px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #222; }
        .track-card img { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; }
        .track-text b { display: block; font-size: 13px; color: var(--primary); }
        .track-text span { font-size: 12px; color: #fff; }

        .btn-skip { background: var(--primary); color: #000; border: none; padding: 15px 30px; border-radius: 50px; font-weight: 900; cursor: pointer; }
    </style>
</head>
<body>

    <div class="player-area">
        <div id="yt-player"></div>
        <div class="now-playing">
            <div class="info-box">
                <span id="status" style="color:var(--primary); font-size:10px; font-weight:900;">LISTO PARA SONAR</span>
                <h2 id="display-title" style="margin: 5px 0;">The Hub Music OSR</h2>
                <p id="display-user" style="margin:0; color:#666;">Esperando primer pedido...</p>
            </div>
            <button class="btn-skip" onclick="playNext()">SIGUIENTE ⏭️</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">PEDIDOS EN TIEMPO REAL</div>
        <div class="list-scroll">
            <span class="section-title">En Fila (Desde Clientes)</span>
            <div id="queue-container"></div>
            <span class="section-title">Ya sonaron</span>
            <div id="history-container"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCk4wgJ2LPicyWnO8XXPQxqu49dtqM8jz4",
            databaseURL: "https://the-hub-music-osr-default-rtdb.firebaseio.com",
            projectId: "the-hub-music-osr"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YT_API_KEY = "AIzaSyBiRDaFPzpNrmg_SHvAZqtBsGXqHXkgK5k";

        let player;
        let lastId = "5NV6Rdv1a0w"; 

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '100%', width: '100%', videoId: lastId,
                events: { 'onStateChange': (e) => { if(e.data === YT.PlayerState.ENDED) playNext(); } }
            });
        }

        // ESCUCHA CONSTANTE DE NUEVOS PEDIDOS
        db.ref('osr_lista').on('value', (snap) => {
            const queue = document.getElementById('queue-container');
            const history = document.getElementById('history-container');
            queue.innerHTML = ""; history.innerHTML = "";
            
            snap.forEach(child => {
                const data = child.val();
                const card = `
                    <div class="track-card">
                        <img src="https://img.youtube.com/vi/${data.id}/mqdefault.jpg">
                        <div class="track-text"><b>${data.user}</b><span>${data.title}</span></div>
                    </div>`;
                if(data.estado === 'reproducida') history.insertAdjacentHTML('afterbegin', card);
                else queue.insertAdjacentHTML('beforeend', card);
            });
        });

        async function playNext() {
            const snap = await db.ref('osr_lista').orderByChild('estado').equalTo(null).limitToFirst(1).once('value');
            if(snap.exists()) {
                snap.forEach(child => {
                    const song = child.val();
                    lastId = song.id;
                    player.loadVideoById(song.id);
                    document.getElementById('display-title').innerText = song.title;
                    document.getElementById('display-user').innerText = "Pedido por: " + song.user;
                    db.ref('osr_lista/' + child.key).update({ estado: 'reproducida' });
                });
            } else { startRadio(); }
        }

        async function startRadio() {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=3&relatedToVideoId=${lastId}&key=${YT_API_KEY}`);
            const data = await res.json();
            const next = data.items[Math.floor(Math.random()*data.items.length)];
            player.loadVideoById(next.id.videoId);
            document.getElementById('display-title').innerText = next.snippet.title;
            document.getElementById('display-user').innerText = "Radio Automática (OSR)";
        }
    </script>
</body>
</html>
