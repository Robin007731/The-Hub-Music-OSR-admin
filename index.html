<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSR Admin Control - Radio Inteligente</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --spotify-green: #1DB954;
            --bg-black: #000000;
            --panel-dark: #121212;
            --card-bg: #181818;
            --text-main: #ffffff;
            --text-dim: #b3b3b3;
        }

        body { background: var(--bg-black); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* PANEL IZQUIERDO */
        .player-section { flex: 2; display: flex; flex-direction: column; background: #000; border-right: 1px solid rgba(255,255,255,0.1); }
        #yt-player { width: 100%; height: 75%; background: #050505; }

        .playback-info { padding: 30px; background: linear-gradient(180deg, rgba(29,185,84,0.1) 0%, rgba(0,0,0,1) 100%); display: flex; align-items: center; flex-grow: 1; }
        .logo-osr { width: 80px; margin-right: 30px; filter: drop-shadow(0 0 15px var(--spotify-green)); }

        .label-status { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; color: var(--spotify-green); margin-bottom: 8px; display: block; }
        #current-title-display { font-size: 24px; font-weight: 900; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 600px; }
        #current-user-display { font-size: 14px; color: var(--text-dim); margin-top: 5px; }

        /* PANEL DERECHO */
        .sidebar-section { flex: 1; background: var(--panel-dark); display: flex; flex-direction: column; min-width: 400px; }
        .sidebar-header { padding: 25px; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .scroll-area { flex: 1; overflow-y: auto; padding: 20px; }
        .section-label { font-size: 11px; font-weight: 800; color: var(--spotify-green); text-transform: uppercase; margin: 25px 0 15px 0; display: block; }

        .track-card { display: flex; align-items: center; background: var(--card-bg); padding: 12px; border-radius: 12px; margin-bottom: 10px; }
        .track-card img { width: 60px; height: 40px; border-radius: 6px; margin-right: 15px; object-fit: cover; }
        .track-info { flex: 1; }
        .track-info b { display: block; font-size: 13px; color: var(--spotify-green); }
        .track-info span { font-size: 12px; color: #fff; }

        .btn-skip { background: white; color: black; border: none; padding: 12px 20px; border-radius: 50px; font-weight: 800; cursor: pointer; margin-left: 20px; }
    </style>
</head>
<body>

    <div class="player-section">
        <div id="yt-player"></div>
        <div class="playback-info">
            <img src="logo-osr.png" class="logo-osr">
            <div style="flex-grow:1; overflow:hidden;">
                <span id="status-tag" class="label-status">● Reproduciendo</span>
                <h1 id="current-title-display">SISTEMA INICIADO</h1>
                <div id="current-user-display">Esperando pedidos...</div>
            </div>
            <button class="btn-skip" onclick="autoSkip()">SALTAR ⏭️</button>
        </div>
    </div>

    <div class="sidebar-section">
        <div class="sidebar-header">
            <h2 style="font-size: 14px; margin:0;">CONTROL HUB OSR</h2>
            <button style="background:#ff4444; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="resetList()">RESET</button>
        </div>
        <div class="scroll-area">
            <span class="section-label">Próximos Pedidos</span>
            <div id="queue-container"></div>
            <span class="section-label">Historial</span>
            <div id="history-container"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCk4wgJ2LPicyWnO8XXPQxqu49dtqM8jz4",
            databaseURL: "https://the-hub-music-osr-default-rtdb.firebaseio.com",
            projectId: "the-hub-music-osr",
            appId: "1:225954155604:web:cb84739b7d7e769661b1c1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YT_API_KEY = "AIzaSyBiRDaFPzpNrmg_SHvAZqtBsGXqHXkgK5k";

        let player;
        let lastPlayedId = "jK6vXreV8Yk"; // Canción de respaldo inicial (OSR Style)
        let isRadioMode = false;

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '100%', width: '100%', videoId: '',
                playerVars: { 'autoplay': 1, 'controls': 1 },
                events: { 'onStateChange': (e) => { if(e.data === YT.PlayerState.ENDED) autoSkip(); } }
            });
        }

        db.ref('osr_lista').on('value', (snapshot) => {
            const queueList = document.getElementById('queue-container');
            const historyList = document.getElementById('history-container');
            queueList.innerHTML = ""; historyList.innerHTML = "";

            if (!snapshot.exists()) return;

            snapshot.forEach((child) => {
                const data = child.val();
                const card = document.createElement('div');
                card.className = 'track-card';
                card.innerHTML = `<img src="https://img.youtube.com/vi/${data.id}/mqdefault.jpg"><div class="track-info"><b>${data.user}</b><span>${data.title}</span></div>`;

                if (data.estado === 'reproducida') historyList.prepend(card);
                else queueList.appendChild(card);
            });
        });

        async function autoSkip() {
            // 1. Intentar buscar el siguiente pedido real en Firebase
            const snap = await db.ref('osr_lista').orderByChild('estado').equalTo(null).limitToFirst(1).once('value');
            
            if (snap.exists()) {
                isRadioMode = false;
                document.getElementById('status-tag').innerText = "● Reproduciendo Pedido";
                document.getElementById('status-tag').style.color = var(--spotify-green);
                
                snap.forEach(child => {
                    const song = child.val();
                    playSong(song.id, song.title, song.user, child.key);
                });
            } else {
                // 2. Si no hay pedidos, activar MODO RADIO (Canciones similares)
                startRadioMode();
            }
        }

        async function startRadioMode() {
            isRadioMode = true;
            document.getElementById('status-tag').innerText = "✨ Modo Radio (Similares)";
            document.getElementById('status-tag').style.color = "#bb86fc";
            document.getElementById('current-user-display').innerText = "Generando música similar automáticamente...";

            try {
                // Buscamos videos relacionados al último que sonó
                const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&relatedToVideoId=${lastPlayedId}&key=${YT_API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    // Elegimos uno al azar de los relacionados para que no sea siempre el mismo
                    const randomIndex = Math.floor(Math.random() * data.items.length);
                    const nextTrack = data.items[randomIndex];
                    playSong(nextTrack.id.videoId, nextTrack.snippet.title, "Sugerencia Automática", null);
                } else {
                    // Si falla, repetimos la última o una base
                    player.loadVideoById(lastPlayedId);
                }
            } catch (e) {
                console.error("Error en Modo Radio:", e);
            }
        }

        function playSong(id, title, user, key) {
            lastPlayedId = id;
            player.loadVideoById(id);
            document.getElementById('current-title-display').innerText = title;
            document.getElementById('current-user-display').innerText = "Pedido por: " + user;
            
            if (key) {
                db.ref('osr_lista/' + key).update({ estado: 'reproducida' });
            }
        }

        function resetList() { if(confirm("¿Limpiar historial?")) db.ref('osr_lista').remove(); }
    </script>
</body>
</html>
