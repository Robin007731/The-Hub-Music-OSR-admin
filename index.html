<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>OSR MASTER ADMIN - Control de Radio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1DB954;
            --bg: #050505;
            --sidebar: #121212;
            --card: #1a1a1a;
            --text: #ffffff;
            --dim: #b3b3b3;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- REPRODUCTOR (LADO IZQUIERDO) --- */
        .player-section { flex: 2; display: flex; flex-direction: column; border-right: 1px solid #222; }
        #yt-player { width: 100%; flex-grow: 1; background: #000; }

        .playback-bar {
            padding: 30px;
            background: linear-gradient(180deg, #121212 0%, #000000 100%);
            display: flex;
            align-items: center;
            border-top: 1px solid #333;
        }

        .now-playing-info { flex-grow: 1; margin-left: 25px; overflow: hidden; }
        .status-pill {
            font-size: 10px;
            font-weight: 900;
            color: var(--primary);
            text-transform: uppercase;
            border: 1px solid var(--primary);
            padding: 2px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 10px;
        }

        #current-title { font-size: 24px; font-weight: 900; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #current-user { font-size: 14px; color: var(--dim); margin: 5px 0 0 0; }

        /* --- SIDEBAR (LADO DERECHO) --- */
        .sidebar { flex: 1; background: var(--sidebar); display: flex; flex-direction: column; min-width: 380px; }
        .sidebar-header { padding: 25px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { font-size: 14px; color: var(--primary); margin: 0; letter-spacing: 1px; }

        .list-container { flex: 1; overflow-y: auto; padding: 20px; }
        .section-label { font-size: 11px; color: var(--dim); text-transform: uppercase; margin: 20px 0 10px 0; display: block; letter-spacing: 1.5px; }

        .track-card {
            display: flex;
            align-items: center;
            background: var(--card);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .track-card:hover { border-color: #444; }
        .track-card img { width: 55px; height: 40px; border-radius: 6px; object-fit: cover; margin-right: 15px; }
        .track-info { flex: 1; overflow: hidden; }
        .track-info b { font-size: 13px; color: var(--primary); display: block; }
        .track-info span { font-size: 12px; color: white; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* BOTONES */
        .btn-skip { background: var(--primary); color: #000; border: none; padding: 15px 35px; border-radius: 50px; font-weight: 900; font-size: 14px; cursor: pointer; transition: 0.3s; }
        .btn-skip:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(29, 185, 84, 0.4); }
        .btn-reset { background: #333; color: #fff; border: none; padding: 5px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="player-section">
        <div id="yt-player"></div>
        <div class="playback-bar">
            <img src="logo-osr.png" style="width: 70px;" onerror="this.src='https://via.placeholder.com/70x70?text=OSR'">
            <div class="now-playing-info">
                <span id="status-tag" class="status-pill">SISTEMA ONLINE</span>
                <h1 id="current-title">ESPERANDO PEDIDOS...</h1>
                <p id="current-user">La música aparecerá aquí cuando los clientes la envíen.</p>
            </div>
            <button class="btn-skip" onclick="playNext()">SIGUIENTE ⏭️</button>
        </div>
    </div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h2>HUB CONTROL MAESTRO</h2>
            <button class="btn-reset" onclick="resetSystem()">RESET</button>
        </div>
        <div class="list-container">
            <span class="section-label">Fila Sincronizada (En Vivo)</span>
            <div id="queue-box"></div>
            
            <span class="section-label">Ya reproducidas</span>
            <div id="history-box"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // CONFIGURACIÓN DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCk4wgJ2LPicyWnO8XXPQxqu49dtqM8jz4",
            databaseURL: "https://the-hub-music-osr-default-rtdb.firebaseio.com",
            projectId: "the-hub-music-osr"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const YT_API_KEY = "AIzaSyBiRDaFPzpNrmg_SHvAZqtBsGXqHXkgK5k";

        let player;
        let lastId = "jK6vXreV8Yk"; // Canción base si no hay nada
        let radioMode = false;

        // INICIAR YOUTUBE PLAYER
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '100%', width: '100%',
                videoId: lastId,
                playerVars: { 'autoplay': 1, 'controls': 1, 'rel': 0 },
                events: { 
                    'onStateChange': (e) => { if(e.data === YT.PlayerState.ENDED) playNext(); },
                    'onReady': (e) => { e.target.setVolume(100); }
                }
            });
        }

        // SINCRONIZACIÓN DE LA FILA (CLIENTES -> ADMIN)
        db.ref('osr_lista').on('value', (snapshot) => {
            const queueBox = document.getElementById('queue-box');
            const historyBox = document.getElementById('history-box');
            queueBox.innerHTML = ""; historyBox.innerHTML = "";

            if (!snapshot.exists()) return;

            snapshot.forEach(child => {
                const data = child.val();
                const card = `
                    <div class="track-card">
                        <img src="https://img.youtube.com/vi/${data.id}/mqdefault.jpg">
                        <div class="track-info">
                            <b>${data.user}</b>
                            <span>${data.title}</span>
                        </div>
                    </div>`;

                if (data.estado === 'reproducida') {
                    historyBox.insertAdjacentHTML('afterbegin', card);
                } else {
                    queueBox.insertAdjacentHTML('beforeend', card);
                }
            });
        });

        // FUNCIÓN SALTAR (LÓGICA PRINCIPAL)
        async function playNext() {
            // Buscamos el primer pedido sin reproducir
            const snap = await db.ref('osr_lista').orderByChild('estado').equalTo(null).limitToFirst(1).once('value');
            
            if (snap.exists()) {
                // Hay pedidos reales
                snap.forEach(child => {
                    const song = child.val();
                    updatePlayer(song.id, song.title, song.user, false);
                    // Sincronizar con clientes: marcar como reproducida
                    db.ref('osr_lista/' + child.key).update({ estado: 'reproducida' });
                });
            } else {
                // Fila vacía: Activar MODO RADIO AUTOMÁTICA
                startRadioAI();
            }
        }

        // MODO RADIO: BUSCAR MÚSICA SIMILAR
        async function startRadioAI() {
            document.getElementById('status-tag').innerText = "✨ MODO RADIO IA";
            document.getElementById('status-tag').style.color = "#bb86fc";
            document.getElementById('status-tag').style.borderColor = "#bb86fc";
            
            try {
                const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=5&relatedToVideoId=${lastId}&key=${YT_API_KEY}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const next = data.items[Math.floor(Math.random() * data.items.length)];
                    updatePlayer(next.id.videoId, next.snippet.title, "Radio OSR (Sugerencia)", true);
                } else {
                    // Si falla, repetir última canción
                    player.playVideo();
                }
            } catch (error) {
                console.error("Error Radio IA:", error);
                player.playVideo();
            }
        }

        function updatePlayer(id, title, user, isRadio) {
            lastId = id;
            player.loadVideoById(id);
            document.getElementById('current-title').innerText = title;
            document.getElementById('current-user').innerText = isRadio ? "Generado automáticamente" : "Pedido por: " + user;
            if (!isRadio) {
                document.getElementById('status-tag').innerText = "● REPRODUCIENDO PEDIDO";
                document.getElementById('status-tag').style.color = var(--primary);
                document.getElementById('status-tag').style.borderColor = var(--primary);
            }
        }

        function resetSystem() {
            if(confirm("¿Borrar todos los pedidos e historial?")) {
                db.ref('osr_lista').remove();
            }
        }
    </script>
</body>
</html>
